pipeline {
  agent any
 
  parameters {
    choice(
        name: 'SERVER', 
        description: 'Servidor donde ejecutar el proceso',
        choices: ["TODOS", "SERVIDOR 1", "SERVIDOR 2", "SERVIDOR 3"]
       )
  } 
  stages {
    stage('Execute task in bd') {
      steps {
        script {
           def executors = [:]
           servers = readJSON file: "servers.json"
           servers['SERVERS'].each {
              server ->  
                    executors[server] = {
                            node {
                              def remote = [:]
                              remote.name = servers[server]['name']
                              remote.host = servers[server]['host']
                              remote.user = servers[server]['user']
                              remote.password = servers[server]['password']
                              remote.allowAnyHosts = true
                              stage('Remote SSH') {
                                def fileContents = readFile file: "${env.WORKSPACE}" + "/" +"restore_db.sh", encoding: "UTF-8"
                                sshScript remote: remote, script: "${env.WORKSPACE}" + "/" +"restore_db.sh"
                              }
                            }
                    }
              }
              parallel executors
        }
      }
    }
  }
}
